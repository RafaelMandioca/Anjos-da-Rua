{% extends 'core/base.html' %}

{% block title %}{{ form_title }}{% endblock %}

{% block content %}
    <style>
        .item-form {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .item-form > .form-group {
            margin-bottom: 0;
            flex-grow: 1;
        }
        .item-form .btn-danger {
            margin-bottom: 15px;
            height: 40px;
        }
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            display: block;
            margin-top: 5px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
    </style>

    <h1>{{ form_title }}</h1>
    <form method="post" novalidate id="atendimentoForm">
        {% csrf_token %}

        <fieldset>
            <legend>Dados do Atendimento</legend>
            {{ form.as_p }}
        </fieldset>

        <hr>

        <fieldset>
            <legend>Itens Utilizados</legend>
            {{ formset.management_form }}
            <div id="item-form-list">
                {% for item_form in formset %}
                    <div class="item-form">
                        {{ item_form.id }}
                        <div class="form-group">
                            {{ item_form.item.label_tag }}
                            {{ item_form.item }}
                        </div>
                        <div class="form-group">
                            {{ item_form.quantidade.label_tag }}
                            {{ item_form.quantidade }}
                            <small class="error-message"></small>
                        </div>
                        <div style="display: none;">{{ item_form.DELETE }}</div>
                        <button type="button" class="btn btn-danger remove-item-form">Remover</button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-item-form" class="btn">Adicionar Outro Item</button>
            
            <div id="empty-item-form" style="display: none;">
                <div class="item-form">
                    {{ formset.empty_form.id }}
                    <div class="form-group">
                        {{ formset.empty_form.item.label_tag }}
                        {{ formset.empty_form.item }}
                    </div>
                    <div class="form-group">
                        {{ formset.empty_form.quantidade.label_tag }}
                        {{ formset.empty_form.quantidade }}
                         <small class="error-message"></small>
                    </div>
                    <div style="display: none;">{{ formset.empty_form.DELETE }}</div>
                    <button type="button" class="btn btn-danger remove-item-form">Remover</button>
                </div>
            </div>
        </fieldset>

        <br>
        <button type="submit" class="btn" id="submit-button">Salvar Atendimento</button>
        <a href="{% url 'atendimentoveterinario-list' %}" class="btn">Cancelar</a>
    </form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formList = document.getElementById('item-form-list');
    const addItemBtn = document.getElementById('add-item-form');
    const emptyFormTemplate = document.getElementById('empty-item-form').innerHTML;
    const totalFormsInput = document.querySelector('[name="{{ formset.prefix }}-TOTAL_FORMS"]');
    const submitButton = document.getElementById('submit-button');
    let stockData = {};

    function parseStockFromOption(option) {
        const match = option.text.match(/Estoque: (\d+)/);
        return match ? parseInt(match[1], 10) : Infinity;
    }

    function validateAllForms() {
        let allFormsValid = true;
        formList.querySelectorAll('.item-form').forEach(formContainer => {
            if (formContainer.style.display === 'none') return;

            const itemSelect = formContainer.querySelector('select[id$="-item"]');
            const quantidadeInput = formContainer.querySelector('input[id$="-quantidade"]');
            const errorElement = formContainer.querySelector('.error-message');
            
            const selectedOption = itemSelect.options[itemSelect.selectedIndex];
            const maxStock = parseStockFromOption(selectedOption);
            const quantidade = parseInt(quantidadeInput.value, 10) || 0;

            if (quantidade > maxStock) {
                errorElement.textContent = `Estoque máximo: ${maxStock}`;
                allFormsValid = false;
            } else {
                errorElement.textContent = '';
            }
        });
        submitButton.disabled = !allFormsValid;
    }

    function addEventListenersToForm(formContainer) {
        const itemSelect = formContainer.querySelector('select[id$="-item"]');
        const quantidadeInput = formContainer.querySelector('input[id$="-quantidade"]');
        
        itemSelect.addEventListener('change', validateAllForms);
        quantidadeInput.addEventListener('input', validateAllForms);
        
        formContainer.querySelector('.remove-item-form').addEventListener('click', function() {
            const deleteInput = formContainer.querySelector('input[type="checkbox"][id$="-DELETE"]');
            if (deleteInput) {
                deleteInput.checked = true;
            }
            formContainer.style.display = 'none';
            validateAllForms(); // Revalida tudo após remover um item
        });
    }

    // Adiciona eventos aos formulários existentes
    formList.querySelectorAll('.item-form').forEach(addEventListenersToForm);

    // Adiciona um novo formulário
    addItemBtn.addEventListener('click', function() {
        let formNum = parseInt(totalFormsInput.value);
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formNum);
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        const newFormElement = tempDiv.firstElementChild;
        
        addEventListenersToForm(newFormElement);
        formList.append(newFormElement);
        totalFormsInput.value = formNum + 1;
        validateAllForms();
    });
    
    // Validação inicial
    validateAllForms();
});
</script>
{% endblock %}